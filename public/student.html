<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>社团管理系统 - 学生端</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- 顶部导航 -->
    <nav class="bg-blue-600 text-white shadow-md">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center">
                <i class="fa fa-university text-2xl mr-3"></i>
                <h1 class="text-xl font-bold">社团管理系统</h1>
            </div>
            <div class="flex items-center">
                <span id="userInfo" class="mr-4"></span>
                <button id="logoutBtn" class="hover:text-blue-200 transition">
                    <i class="fa fa-sign-out mr-1"></i>退出登录
                </button>
            </div>
        </div>
    </nav>

    <!-- 主要内容 -->
    <div class="container mx-auto px-4 py-6">
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">学生工作台</h2>
            <p class="text-gray-600">欢迎使用社团管理系统学生端，您可以在这里提交工时认定材料。</p>
        </div>

        <!-- 工时认定材料提交 -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">提交工时认定材料</h3>
                <button id="toggleWorkFormBtn" class="bg-blue-600 hover:bg-blue-700 text-white py-1 px-3 rounded transition">
                    <i class="fa fa-plus mr-1"></i>新增
                </button>
            </div>

            <!-- 表单区域 -->
            <div id="workFormContainer" class="hidden mb-6 border-t pt-4">
                <form id="workForm" class="space-y-4">
                    <div>
                        <label for="workContent" class="block text-gray-700 font-medium mb-2">工时认定内容</label>
                        <textarea id="workContent" rows="4" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div class="flex justify-end">
                        <button type="button" id="cancelWorkBtn" class="mr-2 bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded transition">
                            取消
                        </button>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded transition">
                            <i class="fa fa-save mr-1"></i>提交
                        </button>
                    </div>
                </form>
            </div>

            <!-- 工时认定列表 -->
            <div>
                <h4 class="text-lg font-semibold text-gray-700 mb-3">我的工时认定记录</h4>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white">
                        <thead>
                            <tr class="bg-gray-100 text-gray-700">
                                <th class="py-3 px-4 text-left">提交时间</th>
                                <th class="py-3 px-4 text-left">内容</th>
                                <th class="py-3 px-4 text-left">状态</th>
                            </tr>
                        </thead>
                        <tbody id="workList">
                            <!-- 工时记录将通过JavaScript动态加载 -->
                            <tr>
                                <td colspan="3" class="py-4 px-4 text-center text-gray-500">加载中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script>
        // 检查登录状态
        const user = checkLogin();
        if (!user || user.role !== 'student') {
            window.location.href = '/';
        }

        // 显示用户信息
        document.getElementById('userInfo').textContent = `欢迎，${user.username} (学生)`;

        // 退出登录
        document.getElementById('logoutBtn').addEventListener('click', () => {
            logout();
        });

        // 工时表单显示/隐藏切换
        document.getElementById('toggleWorkFormBtn').addEventListener('click', () => {
            const formContainer = document.getElementById('workFormContainer');
            formContainer.classList.toggle('hidden');
        });

        // 取消工时提交
        document.getElementById('cancelWorkBtn').addEventListener('click', () => {
            document.getElementById('workFormContainer').classList.add('hidden');
            document.getElementById('workForm').reset();
        });

        // 提交工时认定材料
        document.getElementById('workForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const content = document.getElementById('workContent').value;
            
            try {
                await api.post('/api/work-hours', {
                    submitterId: user.id,
                    submitterRole: user.role,
                    clubId: user.clubId,
                    content: content
                });
                
                // 提交成功后刷新列表并隐藏表单
                loadWorkHours();
                document.getElementById('workForm').reset();
                document.getElementById('workFormContainer').classList.add('hidden');
                
                showToast('工时认定材料提交成功！');
            } catch (error) {
                showToast('提交失败，请稍后重试', 'error');
                console.error('提交工时错误:', error);
            }
        });

        // 加载工时认定记录
        async function loadWorkHours() {
            try {
                const works = await api.get(`/api/work-hours?userId=${user.id}&role=student`);
                const workList = document.getElementById('workList');
                
                if (works.length === 0) {
                    workList.innerHTML = `
                        <tr>
                            <td colspan="3" class="py-4 px-4 text-center text-gray-500">暂无工时认定记录</td>
                        </tr>
                    `;
                    return;
                }
                
                // 按提交时间降序排序
                works.sort((a, b) => new Date(b.submitTime) - new Date(a.submitTime));
                
                workList.innerHTML = works.map(work => `
                    <tr class="border-t hover:bg-gray-50">
                        <td class="py-3 px-4">${formatDate(work.submitTime)}</td>
                        <td class="py-3 px-4">${work.content}</td>
                        <td class="py-3 px-4">
                            <span class="px-2 py-1 rounded text-sm ${
                                work.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                                work.status === 'approved' ? 'bg-green-100 text-green-800' :
                                'bg-red-100 text-red-800'
                            }">
                                ${getStatusText(work.status)}
                            </span>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('加载工时记录错误:', error);
                document.getElementById('workList').innerHTML = `
                    <tr>
                        <td colspan="3" class="py-4 px-4 text-center text-red-500">加载失败，请刷新页面重试</td>
                    </tr>
                `;
            }
        }

        // 页面加载时加载数据
        loadWorkHours();
    </script>
</body>
</html>
